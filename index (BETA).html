<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>BARCODE REFUELING MACO HAULING - BETA VERSION</title>
  
  <!-- üîó PWA MANIFEST LINK -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3B82F6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QR Scan">

  <script src="https://unpkg.com/html5-qrcode@latest"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

   <style>
    /* --- PALET WARNA CYBERPUNK --- */
    :root {
      --neon-blue: #00f3ff;
      --neon-green: #0aff68;
      --neon-red: #ff0055;
      --dark-bg: #050b14;
      --glass-bg: rgba(12, 24, 40, 0.92); /* Lebih gelap dikit biar teks jelas */
      --border-color: rgba(0, 243, 255, 0.5);
      --text-main: #e0f2fe;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Rajdhani', sans-serif; 
      background-color: var(--dark-bg);
      background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.9)), url('PITSTOP-39.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: var(--text-main);
      overflow-x: hidden;
      line-height: 1.5; /* Jarak antar baris lebih lega */
    }

    /* --- ANIMASI --- */
    @keyframes scanline {
      0% { top: 0%; opacity: 0; }
      20% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
    
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes slideUpFadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
    .slide-up-fade-in { animation: slideUpFadeIn 0.5s ease-out forwards; }

    /* --- LOGIN PAGE --- */
    #loginPage {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
    }
    
    .login-container { width: 100%; max-width: 480px; } /* Diperlebar sedikit */

    .login-box {
      background: var(--glass-bg);
      border: 2px solid var(--border-color); /* Border lebih tebal */
      border-radius: 20px;
      padding: 50px 30px;
      box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
      text-align: center;
      position: relative;
      backdrop-filter: blur(15px);
    }

    /* Garis Hiasan Atas */
    .login-box::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
      box-shadow: 0 0 15px var(--neon-blue);
    }

    .main-site-title {
      font-family: 'Orbitron', sans-serif;
      color: var(--neon-blue);
      text-align: center;
      font-size: 32px; /* DIPERBESAR */
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 30px;
      text-shadow: 0 0 20px var(--neon-blue);
      line-height: 1.2;
    }

    .logo-header img {
      width: 70px; height: 70px; /* Logo lebih besar */
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.6));
      margin-bottom: 10px;
    }

    .login-box h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      color: #fff;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .login-box p { color: #94a3b8; font-size: 15px; margin-bottom: 30px; font-weight: 500; }

    /* --- INPUT FIELDS (LOGIN) --- */
    .form-group { margin-bottom: 25px; text-align: left; }
    
    .form-group label { 
      color: var(--neon-blue); 
      font-weight: 700; 
      letter-spacing: 1px; 
      font-size: 16px; /* Label lebih besar */
      margin-bottom: 8px;
      display: block;
      text-transform: uppercase;
    }

    .form-group select, .form-group input {
      width: 100%;
      background: rgba(0, 0, 0, 0.6) !important;
      border: 2px solid rgba(255, 255, 255, 0.2) !important;
      color: #fff !important;
      font-family: 'Orbitron', sans-serif;
      padding: 16px; /* Padding lebih lega */
      font-size: 18px !important; /* Teks input besar */
      border-radius: 12px !important;
      transition: 0.3s;
    }

    .form-group select:focus, .form-group input:focus {
      border-color: var(--neon-blue) !important;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.4);
      outline: none;
      background: rgba(0, 0, 0, 0.8) !important;
    }

    /* --- TOMBOL UTAMA --- */
    .login-btn {
      width: 100%;
      background: linear-gradient(180deg, rgba(0,243,255,0.15), rgba(0,243,255,0.05)) !important;
      border: 2px solid var(--neon-blue) !important;
      color: var(--neon-blue) !important;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-weight: 800;
      padding: 18px; /* Tombol tebal */
      font-size: 18px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,243,255,0.2);
      transition: all 0.3s;
      cursor: pointer;
      margin-top: 10px;
    }

    .login-btn:hover {
      background: var(--neon-blue) !important;
      color: #000 !important;
      box-shadow: 0 0 35px var(--neon-blue);
      transform: translateY(-2px);
    }
    
    .login-footer { color: #64748b; margin-top: 30px; font-size: 12px; letter-spacing: 1px; }

    /* --- SCANNER PAGE --- */
    #scannerPage {
      display: none; min-height: 100vh;
      background: transparent;
      flex-direction: column;
      opacity: 0; transition: opacity 0.5s ease-out;
    }
    #scannerPage.active { opacity: 1; }

    .scanner-header {
      background: rgba(5, 11, 20, 0.95);
      border-bottom: 2px solid var(--border-color);
      padding: 20px 25px;
      display: flex; justify-content: space-between; align-items: center;
      backdrop-filter: blur(10px);
    }

    .scanner-header h1 { color: #fff; font-family: 'Orbitron'; font-size: 22px; font-weight: 800; }

    .user-badge {
      background: rgba(0, 243, 255, 0.1);
      border: 1px solid var(--neon-blue);
      color: var(--neon-blue);
      font-family: 'Orbitron';
      letter-spacing: 1px;
      padding: 8px 15px;
      font-weight: 700;
      border-radius: 8px;
    }

    .logout-btn {
      background: rgba(255, 0, 85, 0.2);
      border: 1px solid var(--neon-red);
      color: var(--neon-red);
      font-family: 'Orbitron';
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    .scanner-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .scanner-main { width: 100%; max-width: 500px; } /* Lebar area scan ditambah */

    /* --- KOTAK QR CODE --- */
    .qr-display-area {
      background: var(--glass-bg);
      border: 2px solid var(--border-color);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 0 50px rgba(0,0,0,0.6);
    }

    .qr-display-area h2 { 
      color: #fff; font-family: 'Orbitron'; margin-bottom: 20px; font-size: 20px; 
      text-transform: uppercase; letter-spacing: 2px;
    }

    /* --- WRAPPER KAMERA (FRAME) --- */
    .qr-reader-wrapper {
      position: relative;
      border: 3px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden; 
      box-shadow: 0 0 25px rgba(0, 243, 255, 0.15);
      background: #000; 
      /* Memastikan wrapper punya tinggi saat loading */
      min-height: 250px; 
    }

    /* --- GARIS LASER MERAH (PERBAIKAN VISIBILITY) --- */
    .qr-reader-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0; 
      width: 100%; 
      height: 4px; /* Laser lebih tebal sedikit */
      
      /* Warna Merah Solid + Glow (Biar pasti kelihatan) */
      background: var(--neon-red);
      box-shadow: 0 0 20px var(--neon-red), 0 0 40px var(--neon-red);
      
      /* Animasi Turun Naik */
      animation: scanline 2s infinite linear;
      
      /* KUNCI PERBAIKAN: Z-Index Tinggi & Pointer Events */
      z-index: 999; 
      pointer-events: none;
    }

    /* Video dari library kadang menutupi, kita paksa di bawah */
    #qr-reader video {
        object-fit: cover;
        z-index: 1;
    }

    #qr-reader { border: none; background: #000; }

    .camera-toggle-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      
      width: 50px; height: 50px; /* Ukuran Bola */
      border-radius: 50%; /* Membuat jadi Bulat Sempurna */
      
      background: rgba(0, 0, 0, 0.6); /* Transparan Gelap */
      border: 2px solid var(--border-color); /* Garis Neon Biru */
      color: var(--neon-blue);
      
      display: flex; justify-content: center; align-items: center;
      font-size: 24px; /* Ukuran Ikon Kamera */
      cursor: pointer;
      z-index: 20; /* Agar di atas video kamera */
      
      backdrop-filter: blur(5px);
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      transition: all 0.4s ease;
    }

    /* Efek saat Hover (Disentuh) */
    .camera-toggle-btn:hover {
      background: var(--neon-blue);
      color: #000;
      border-color: #fff;
      box-shadow: 0 0 25px var(--neon-blue);
      transform: rotate(180deg) scale(1.1); /* Animasi Putar & Membesar */
    }

    /* --- HASIL SCAN --- */
    #result {
      background: rgba(0,0,0,0.6);
      border: 1px solid #555;
      color: #fff;
      font-family: 'Rajdhani';
      font-size: 18px; /* Teks hasil lebih besar */
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      font-weight: 600;
    }

    #result.status-allowed {
      background: rgba(10, 255, 104, 0.2);
      border: 2px solid var(--neon-green);
      color: var(--neon-green);
      text-shadow: 0 0 10px var(--neon-green);
    }

    #result.status-disallowed {
      background: rgba(255, 0, 85, 0.2);
      border: 2px solid var(--neon-red);
      color: var(--neon-red);
      text-shadow: 0 0 10px var(--neon-red);
    }

    /* --- POSISI TOMBOL (DI TENGAH) --- */
    .action-btns {
      display: flex;
      gap: 25px; /* Jarak antar tombol Play & Stop */
      justify-content: center; /* <--- INI KUNCI BIAR DI TENGAH */
      align-items: center;
      margin-top: 20px;
    }

    .action-btns button {
      width: 70px; height: 70px; /* Ukuran tombol mantap */
      font-size: 30px; 
      border-radius: 50%; /* Dibuat Bulat biar lebih modern */
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek membal saat ditekan */
    }

    /* --- INPUT QUANTITY AREA --- */
    #quantityArea {
      background: var(--glass-bg) !important;
      border: 2px solid var(--border-color);
      border-radius: 24px !important;
      color: #fff;
      padding: 40px 25px !important;
    }

    #quantityArea h2 { 
      color: var(--neon-blue) !important; 
      font-family: 'Orbitron'; 
      font-size: 24px !important;
      text-shadow: 0 0 15px var(--neon-blue);
      margin-bottom: 15px !important;
    }
    
    #quantityArea p { color: #cbd5e1 !important; font-size: 16px !important; margin-bottom: 30px !important; }

    #targetUnitDisplay {
      background: rgba(0, 243, 255, 0.05) !important;
      border: 2px dashed var(--neon-blue) !important;
      border-radius: 16px !important;
      padding: 20px !important;
      margin-bottom: 30px !important;
    }

    #targetUnitID { 
      color: var(--neon-blue) !important; 
      font-family: 'Orbitron'; 
      font-size: 42px !important; /* UNIT ID RAKSASA */
      font-weight: 900 !important;
      text-shadow: 0 0 20px var(--neon-blue);
    }
    
    #targetUnitSpec { color: #fff !important; opacity: 0.9; font-size: 14px !important; letter-spacing: 1px; }

    /* --- INPUT LITER & HM BESAR (SUPER JELAS) --- */
    #literInput, #hmInput {
      background: #000 !important;
      border: 3px solid var(--border-color) !important;
      color: var(--neon-blue) !important;
      font-family: 'Orbitron';
      font-size: 50px !important; /* INPUT RAKSASA */
      height: 90px !important;
      text-shadow: 0 0 10px var(--neon-blue);
      border-radius: 16px !important;
      margin-top: 5px;
    }
    
    #literInput:focus, #hmInput:focus {
      border-color: var(--neon-blue) !important;
      box-shadow: 0 0 30px rgba(0, 243, 255, 0.5) !important;
    }
    
    /* Label Input Khusus */
    #quantityArea label {
        font-size: 16px !important;
        letter-spacing: 1px;
        color: #fff !important;
        margin-bottom: 10px !important;
    }

    /* --- TOMBOL SIMPAN --- */
    .btn-save-liter {
      background: linear-gradient(135deg, var(--neon-green), #059669) !important;
      color: #000 !important;
      font-family: 'Orbitron';
      font-size: 22px !important; /* Teks tombol simpan besar */
      font-weight: 800 !important;
      letter-spacing: 2px;
      box-shadow: 0 0 20px var(--neon-green);
      border: none !important;
      padding: 20px !important;
      border-radius: 16px !important;
      margin-top: 20px;
      cursor: pointer;
    }

    .btn-save-liter:hover {
      box-shadow: 0 0 40px var(--neon-green);
      transform: scale(1.02);
    }
    
    /* Tombol Batal */
    button[onclick="location.reload()"] {
        background: rgba(220, 38, 38, 0.2) !important;
        border: 2px solid var(--neon-red) !important;
        color: var(--neon-red) !important;
        font-size: 16px !important;
        padding: 15px !important;
        border-radius: 12px !important;
        text-transform: uppercase;
        font-family: 'Orbitron';
        letter-spacing: 1px;
    }

    /* --- TOMBOL START/STOP --- */
    /* --- TOMBOL PLAY (SEGITIGA HIJAU) --- */
    #startBtn {
      background: rgba(10, 255, 104, 0.15) !important; /* Hijau Transparan */
      border: 3px solid var(--neon-green) !important;   /* Garis Hijau */
      color: var(--neon-green) !important;              /* Ikon Segitiga Hijau */
      box-shadow: 0 0 20px rgba(10, 255, 104, 0.2);     /* Cahaya Hijau Halus */
    }

    #startBtn:hover {
      background: var(--neon-green) !important;         /* Hijau Penuh saat disentuh */
      color: #000 !important;                           /* Ikon jadi hitam */
      box-shadow: 0 0 40px var(--neon-green);           /* Cahaya makin terang */
      transform: scale(1.15);                           /* Membesar sedikit */
    }

    /* --- TOMBOL STOP (KOTAK MERAH) - Biar seimbang --- */
    #stopBtn {
      background: rgba(255, 0, 85, 0.15) !important;
      border: 3px solid var(--neon-red) !important;
      color: var(--neon-red) !important;
      box-shadow: 0 0 20px rgba(255, 0, 85, 0.2);
    }

    #stopBtn:hover {
      background: var(--neon-red) !important;
      color: #000 !important;
      box-shadow: 0 0 40px var(--neon-red);
      transform: scale(1.15);
    }

    /* --- BANNER OFFLINE (FIXED VERSION) --- */
    .offline-banner {
      display: none; 
      background: #000;
      color: var(--neon-red);
      border-bottom: 3px solid var(--neon-red);
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      padding: 15px;
      text-align: center;
      font-size: 14px;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 5px 20px rgba(255, 0, 85, 0.4);
    }
    
    .offline-banner.show { display: block; }
    
    .scanner-footer {
      background: rgba(0,0,0,0.9);
      color: #666;
      border-top: 1px solid #333;
      padding: 20px;
      font-size: 13px;
    }

    /* --- RESPONSIVE MOBILE (AGAR TIDAK PECAH DI HP) --- */
    @media (max-width: 480px) {
      .main-site-title { font-size: 22px; margin-bottom: 25px; }
      .login-box { padding: 40px 20px; }
      .form-group input, .form-group select { font-size: 16px !important; padding: 14px; }
      
      #literInput, #hmInput { 
          font-size: 40px !important; /* Tetap besar tapi pas di HP */
          height: 80px !important; 
          width: 100% !important;
      }
      
      /* --- REVISI HEADER MOJOK KANAN --- */
      .scanner-header { 
          display: flex;
          justify-content: space-between; /* Pisahkan Kiri (Judul) dan Kanan (Info) sejauh mungkin */
          align-items: center;
          padding: 15px 20px; /* Tambah padding dikit biar ga nempel layar */
      }

      /* Tampilkan judul "QR Scan" tapi kecil saja sebagai penyeimbang di Kiri */
      .scanner-header h1 { 
          display: block !important; 
          font-size: 16px; 
          margin: 0;
      } 
      
      /* Area Kanan (Bays & Logout) */
      .header-info {
          display: flex;
          flex-direction: column; /* Susun Atas-Bawah biar rapi */
          align-items: flex-end;  /* Rata Kanan MENTOK */
          gap: 6px; /* Jarak antara badge dan tombol */
      }
      
      /* Kecilkan dikit font badge di HP */
      .user-badge { 
          font-size: 12px; 
          padding: 4px 10px; 
      }
      
      .logout-btn {
          font-size: 11px;
          padding: 4px 10px;
      }

      .qr-display-area { padding: 20px; }
      #targetUnitID { font-size: 32px !important; }
    }

    /* --- STATUS SUKSES UPLOAD OFFLINE --- */
    .offline-banner.success-sync {
      background: rgba(10, 255, 104, 0.15) !important; /* Latar Hijau Transparan */
      border-bottom: 3px solid var(--neon-green) !important; /* Garis Bawah Hijau */
      color: var(--neon-green) !important; /* Teks Hijau */
      box-shadow: 0 5px 20px rgba(10, 255, 104, 0.3); /* Cahaya Hijau */
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>

</head>
<body>

<div class="offline-banner" id="offlineBanner">üì° Mode Offline - Data akan disimpan lokal</div>

<div id="loginPage">
  <div class="login-container">
    <h1 class="main-site-title">DIGITALISASI LOG MACO HAULING ERA</h1> 
    <div class="login-box">
      <div class="logo-header">
        <h1 style="margin:0;font-size:24px;">Refueling QR</h1>
      </div>
      <p>Login dengan akun sesuai dengan lokasi BAYS anda, Untuk memulai proses scan</p>
      <div class="error-box" id="errorMsg"></div>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Username Bays</label>
          <select id="bays" required>
            <option value="">Pilih Bays</option>
            <option value="bays 1">Bays 1 (LINE A)</option>
            <option value="bays 2">Bays 2 (LINE B)</option>
            <option value="bays 3">Bays 3 (LINE C)</option>
          </select>
        </div>
        <div class="form-group">
          <label>üîë Password</label>
          <input type="password" id="pwd" placeholder="Masukkan password" required>
        </div>
        <button type="submit" class="login-btn" id="loginBtn">LOGIN</button>
      </form>
      <div class="login-footer">Design by FOG HAULING MACO</div>
    </div>
  </div>
</div>

<div id="scannerPage">
  <div class="scanner-header">
    <h1>üì± QR Scan</h1>
    <div class="header-info">
      <div class="user-badge" id="userInfo">-</div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="scanner-content">
    <div class="scanner-main"> <div class="qr-display-area">
        <h2>Scan QR Code</h2>
        <div class="qr-reader-wrapper">
          <div id="qr-reader"></div>
          <button class="camera-toggle-btn" id="cameraToggleBtn" onclick="toggleCamera()" title="Tukar Kamera">üì∑</button>
        </div>
        <div id="result"><span>Tekan ‚ñ∂ untuk mulai</span></div>
        <div class="action-btns">
          <button id="startBtn">‚ñ∂</button>
          <button id="stopBtn">‚èπ</button>
        </div>
      </div>

        <div id="quantityArea" style="display: none; background: white; border-radius: 24px; padding: 30px 15px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); width: 100%; margin: 0 auto; box-sizing: border-box;">
        
    <p style="text-align: center; color: #4B5563; font-size: 15px; font-weight: 600; margin-bottom: 15px; letter-spacing: 0.5px;">
        Silahkan isi Data untuk unit berikut!
    </p>

    <div id="targetUnitDisplay" style="background: #EFF6FF; padding: 15px; border-radius: 16px; margin-bottom: 30px; border: 2px dashed #BFDBFE;">
        <span id="targetUnitID" style="display:block; font-weight: 800; color: #1D4ED8; font-size: 26px; letter-spacing: 1px;">-</span>
        <span id="targetUnitSpec" style="display:block; font-weight: 600; color: #64748B; font-size: 12px; text-transform: uppercase; margin-top: 5px;">-</span>
    </div>

    <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">

        <div style="width: 310px; margin-bottom: 25px;">
            <label style="color: #059669; font-size: 14px; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 8px; text-align: left; padding-left: 85px;">
                ISI SOLAR (LITER)
            </label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 70px; height: 75px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 60px; line-height: 1;">‚õΩ</span>
                </div>
                <input type="number" id="literInput" inputmode="numeric" placeholder="0" max="333"
                       oninput="checkLiterLimit(this)"
                       style="width: 220px; height: 75px; font-size: 40px; font-weight: 800; text-align: center; border: 3px solid #10B981; border-radius: 16px; color: #064E3B; background-color: #ECFDF5;">
            </div>
            <div id="literWarning" style="color: #DC2626; font-size: 12px; font-weight: bold; display: none; margin-top: 5px; background: #FEE2E2; padding: 5px; border-radius: 8px;">
                ‚ö†Ô∏è Maksimal 333 Liter!
            </div>
        </div>

        <div style="width: 310px; margin-bottom: 30px;">
            <label style="color: #1F2937; font-size: 14px; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 8px; text-align: left; padding-left: 85px;">
                INPUT HOURS METER (HM) <span style="color: #DC2626; font-size: 18px;">*</span>
            </label>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 70px; height: 75px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 60px; line-height: 1;">‚öôÔ∏è</span>
                </div>
                <input type="number" id="hmInput" inputmode="decimal" placeholder="0.0" step="0.1" required
                       style="width: 220px; height: 75px; font-size: 35px; font-weight: 800; text-align: center; border: 3px solid #3B82F6; border-radius: 16px; color: #1E3A8A; background-color: #EFF6FF;">
            </div>
        </div>

    </div>

    <button onclick="submitFinalData()" class="login-btn btn-save-liter" id="saveLiterBtn" style="margin-top: 10px; width: 100%; height: 60px; font-size: 20px; letter-spacing: 1px; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);">
        SIMPAN DATA
    </button>
    
    <div style="margin-top: 15px;">
        <button onclick="location.reload()" style="background-color: #EF4444; color: white; border: none; border-radius: 12px; width: 100%; padding: 12px; font-weight: 700; font-size: 14px; cursor: pointer;">
            ‚ùå BATAL / KEMBALI
        </button>
    </div>
</div>

      </div>

    </div> </div>
  </div>
  <div class="scanner-footer">¬© 2025 Refueling QR System | Logistik Hauling MACO</div>
</div>

<script>

let isSyncing = false; // Kunci untuk mencegah duplikasi pengiriman antreans
let currentUnitId = null; // <--- TEMPELKAN DI SINI (Variabel Global)
let currentLastHM = 0; // <--- Tambahkan ini untuk menyimpan history HM dari server
let isProcessing = false; // Kunci agar tidak terjadi pengiriman ganda
let bannerTimeout = null; // <--- TAMBAHKAN INI (Untuk mengontrol timer banner)

const CREDS = {
  "bays 1": { pwd: "qwerty", line: "A" },
  "bays 2": { pwd: "asdfgh", line: "B" },
  "bays 3": { pwd: "12345", line: "C" }
};

// ‚úÖ UPDATED URL - Apps Script V20.0
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbxSw-MkiOCwrJLZvhGNfqdFiWsMtomPXMOWh7sIAlvDyZ1K-uluB-mVVecLBiZcA6eSSQ/exec";

let user = null, line = null, qr = null, scanning = false, lastCode = null;
let cameraFacing = "environment";
let isOnline = navigator.onLine;
let apiRetryCount = 0;
const MAX_RETRIES = 3;
let apiUrl = DEFAULT_API_URL;
let validUnitIds = new Set();
let refuelDB = {};

// --- UPDATE BAGIAN ATAS SCRIPT ---
window.addEventListener('online', () => {
  isOnline = true;
  document.getElementById('offlineBanner').classList.remove('show');
  uploadPendingData(); // <--- BARIS BARU: Upload otomatis saat sinyal nyala
  loadRefuelDatabase();
});

window.addEventListener('offline', () => {
  isOnline = false;
  
  const banner = document.getElementById('offlineBanner');
  
  // 1. Matikan timer "Success" jika sedang berjalan (Agar banner tidak hilang sendiri)
  if (bannerTimeout) clearTimeout(bannerTimeout);

  // 2. Paksa Reset Tampilan (Hapus Hijau, Paksa Merah)
  banner.classList.remove('success-sync'); 
  
  // 3. Paksa Ganti Teks
  banner.innerHTML = "üì° Mode Offline - Data akan disimpan lokal";
  
  // 4. Munculkan Banner
  banner.classList.add('show');
});

window.addEventListener("load", () => {
  if (!isOnline) {
    document.getElementById('offlineBanner').classList.add('show');
  } else {
    uploadPendingData(); // <--- BARIS BARU: Cek antrean saat aplikasi dibuka
  }
  // ... sisa kode window load biarkan sama ...
  const s = localStorage.getItem("s");
  if(s) {
    const { u, l } = JSON.parse(s);
    user = u; line = l;
    showScanner();
    loadRefuelDatabase();
  }
});

function extractUnitIdFromQR(qrData) {
  const normalized = String(qrData).trim().toUpperCase();
  if (normalized.includes('|')) {
    return normalized.split('|')[0].trim();
  }
  return normalized;
}

async function loadRefuelDatabase() {
  try {
    // --- SKENARIO 1: JIKA ONLINE (Download Kamus Data + History Global) ---
    if (isOnline) {
      const formData = new FormData();
      formData.append("action", "getRefuelDB");
      formData.append("line", line);
      
      // Tips: Tambahkan redirect: 'follow' agar aman di Android
      const response = await fetch(apiUrl, { method: "POST", body: formData, redirect: "follow" });
      const data = await response.json();
      
      if (data.status === 'success') {
        // A. UPDATE SPEK UNIT (KAMUS)
        // Kita ambil "unitDetails" (Kamus ID + Nama)
        const dictionary = data.refuelDB.unitDetails || {}; 
        
        // Simpan Kamus Lengkap ke Memori HP
        localStorage.setItem('unitDetailsDB', JSON.stringify(dictionary)); 
        
        // üî• B. UPDATE HISTORY GLOBAL (BAGIAN BARU - SMART OFFLINE GUARD) üî•
        // Kita ambil data history transaksi terakhir dari seluruh Bays (yang dikirim Backend)
        const serverHistory = data.refuelDB.lastHistory || {};
        
        // Simpan ke memori 'unitHistory' di HP.
        // Dengan ini, HP Bays 3 jadi "tahu" kalau Unit X baru saja isi di Bays 1.
        // Cek dulu apakah datanya ada, baru simpan.
        if (Object.keys(serverHistory).length > 0) {
             localStorage.setItem('unitHistory', JSON.stringify(serverHistory));
             console.log(`üîÑ Global History Terupdate: ${Object.keys(serverHistory).length} data transaksi.`);
        }
        
        // C. Update Set Validasi (RAM)
        const units = Object.keys(dictionary);
        validUnitIds = new Set(units);
        
        console.log(`‚úÖ Database Online Terupdate: ${units.length} unit beserta speknya.`);
      }
    } 
    // --- SKENARIO 2: JIKA OFFLINE (Buka Kamus dari Memori HP) ---
    else {
      const localDetails = localStorage.getItem('unitDetailsDB');
      if (localDetails) {
        const dictionary = JSON.parse(localDetails);
        
        // Ambil daftar ID dari kamus yang tersimpan
        validUnitIds = new Set(Object.keys(dictionary));
        
        console.log(`üì° Database Offline Loaded: Siap mengenali ${validUnitIds.size} unit.`);
      }
    }
  } catch (err) {
    console.error('Gagal load DataBase, mencoba akses lokal:', err);
    // Fallback darurat jika server error/timeout
    const localDetails = localStorage.getItem('unitDetailsDB');
    if (localDetails) {
        const dictionary = JSON.parse(localDetails);
        validUnitIds = new Set(Object.keys(dictionary));
    }
  }
}

function isValidUnitFrontend(unitId) {
  const normalized = String(unitId).trim().toUpperCase();
  const extractedUnit = normalized.includes('|') 
    ? normalized.split('|')[0].trim() 
    : normalized;
  
  if (validUnitIds.size > 0 && !validUnitIds.has(extractedUnit)) {
    console.warn(`‚ùå Invalid unit: ${extractedUnit} - tidak ada di database`);
    return false;
  }
  return true;
}

function handleLogin(e) {
  e.preventDefault();
  const b = document.getElementById("bays").value;
  const p = document.getElementById("pwd").value;
  const err = document.getElementById("errorMsg");
  const loginBtn = document.getElementById("loginBtn");
  
  if(!b || !CREDS[b] || CREDS[b].pwd !== p) {
    err.textContent = "‚ùå Username atau password salah!";
    err.style.display = "block";
    return;
  }
  
  user = b;
  line = CREDS[b].line;
  localStorage.setItem("s", JSON.stringify({ u: user, l: line }));
  document.querySelector("form").reset();
  err.style.display = "none";
  
  loginBtn.disabled = true;
  loginBtn.textContent = "‚è≥ Loading...";
  
  loadRefuelDatabase().then(() => {
    setTimeout(() => {
      transitionToScanner();
      loginBtn.disabled = false;
      loginBtn.textContent = "LOGIN";
    }, 500);
  }).catch(() => {
    err.textContent = "‚ùå Gagal load database dari server";
    err.style.display = "block";
    loginBtn.disabled = false;
    loginBtn.textContent = "LOGIN";
  });
}

function transitionToScanner() {
  const loginPage = document.getElementById("loginPage");
  const scannerPage = document.getElementById("scannerPage");
  
  loginPage.classList.add("fade-out");
  
  setTimeout(() => {
    loginPage.style.display = "none";
    scannerPage.style.display = "flex";
    scannerPage.offsetHeight;
    scannerPage.classList.add("slide-up-fade-in");
    scannerPage.classList.add("active");
    
    document.getElementById("userInfo").textContent = `üë§ ${user.toUpperCase()} (${line}) | Units: ${validUnitIds.size}`;
    
    setTimeout(() => {
      const sb = document.getElementById("startBtn");
      const stb = document.getElementById("stopBtn");
      if(sb && stb) {
        sb.onclick = () => startScan();
        stb.onclick = () => stopScan();
      }
    }, 100);
  }, 500);
}

function logout() {
  if(confirm("Logout?")) {
    localStorage.removeItem("s");
    user = null; line = null;
    validUnitIds.clear();
    refuelDB = {};
    cameraFacing = "environment";
    apiRetryCount = 0;
    if(qr && scanning) qr.stop().then(() => qr.clear()).catch(() => {});
    
    const loginPage = document.getElementById("loginPage");
    const scannerPage = document.getElementById("scannerPage");
    
    scannerPage.classList.remove("active");
    scannerPage.classList.add("fade-out");
    
    setTimeout(() => {
      scannerPage.style.display = "none";
      scannerPage.classList.remove("fade-out", "slide-up-fade-in");
      loginPage.style.display = "flex";
      loginPage.classList.remove("fade-out");
    }, 500);
  }
}

function showScanner() {
  const loginPage = document.getElementById("loginPage");
  const scannerPage = document.getElementById("scannerPage");
  
  loginPage.style.display = "none";
  scannerPage.style.display = "flex";
  scannerPage.classList.add("active");
  document.getElementById("userInfo").textContent = `üë§ ${user.toUpperCase()} (${line})`;
  
  setTimeout(() => {
    const sb = document.getElementById("startBtn");
    const stb = document.getElementById("stopBtn");
    if(sb && stb) {
      sb.onclick = () => startScan();
      stb.onclick = () => stopScan();
    }
  }, 100);
}

// --- FUNGSI TUKAR KAMERA (ANTI MACET) ---
function toggleCamera() {
  if (!scanning) {
    alert("Kamera belum menyala! Tekan tombol Play (Segitiga Hijau) dulu.");
    return;
  }
  
  if(qr) {
    // Stop dulu kamera lama
    qr.stop().then(() => {
      qr.clear();
      scanning = false; // Reset status sebentar
      
      // Tukar Mode Kamera
      cameraFacing = cameraFacing === "environment" ? "user" : "environment";
      
      // Nyalakan lagi
      startScan();
      
    }).catch((err) => {
      console.error("Gagal stop kamera:", err);
      scanning = false; // Paksa reset jika error
      alert("Gagal menukar kamera. Silakan tekan Play lagi.");
    });
  }
}

function toHourMinute(minutes) {
  const jam = Math.floor(minutes / 60);
  const menit = Math.round(minutes % 60);
  
  // Logika supaya bahasanya enak didengar
  if (jam > 0) {
    return `${jam} Jam ${menit} Menit`; // Dibaca lengkap
  } else {
    return `${menit} Menit`;
  }
}

function extractUnitNumber(qrText) {
  // Mengambil teks sebelum tanda '|' dan membersihkan spasi
  const normalized = String(qrText).trim().toUpperCase();
  return normalized.includes('|') ? normalized.split('|')[0].trim() : normalized;
}

// ‚úÖ SIMPLIFIED: Parse DD/MM/YYYY HH:MM:SS format dari backend
function parseTimestampSimple(timestampStr) {
  if (!timestampStr) return "Barusan";
  
  try {
    // Biarkan Javascript memproses format ISO dari Google secara otomatis
    const date = new Date(timestampStr);
    
    // Pastikan valid
    if (isNaN(date.getTime())) return "-"; 
    
    // Ambil Jam dan Menit (Format 24 Jam)
    const jam = date.getHours().toString().padStart(2, '0');
    const menit = date.getMinutes().toString().padStart(2, '0');
    
    return `${jam}:${menit}`; // Contoh Output: "14:30"
  } catch (err) {
    console.error("Error parsing date:", err);
    return "-";
  }
}

function speak(text, beepType = null) {
  showVibrateNotification("üîä Notifikasi", text);
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (beepType) {
    playBeep(beepType);
    if (isIOS) {
      setTimeout(() => {
        speakVoice(text);
      }, 1000);
    } else {
      speakVoice(text);
    }
  } else {
    speakVoice(text);
  }
}

function speakVoice(text) {
  if (!window.speechSynthesis) return;
  const synth = window.speechSynthesis;
  synth.cancel();
  let utter = new SpeechSynthesisUtterance(text);
  utter.lang = "id-ID";
  utter.rate = 0.95;
  utter.pitch = 1.0;
  utter.volume = 1.0;
  const voices = synth.getVoices();
  const indonesianVoice = voices.find(v => v.lang === 'id-ID' || v.lang.startsWith('id'));
  if (indonesianVoice) {
    utter.voice = indonesianVoice;
  }
  try {
    if (window.AudioContext || window.webkitAudioContext) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }
  } catch (e) {
    console.log("Audio context error:", e);
  }
  try {
    synth.speak(utter);
  } catch (err) {
    console.error("Speak error:", err);
  }
}

function showVibrateNotification(title, message) {
  if (navigator.vibrate) {
    navigator.vibrate([50, 30, 50, 30, 50]);
  }
  showLargeToast(title, message);
}

function showLargeToast(title, message, duration = 4000) {
  const existing = document.querySelector('.toast-notification');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div style="font-weight: 700; margin-bottom: 8px; font-size: 18px; line-height: 1.2;">${title}</div>
    <div style="font-weight: 500; font-size: 15px; line-height: 1.6;">${message}</div>
  `;
  toast.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(30, 30, 30, 0.95));
    color: #fff;
    padding: 20px 24px;
    border-radius: 16px;
    font-size: 15px;
    z-index: 9999;
    max-width: 340px;
    text-align: center;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.2);
  `;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(10px)';
    toast.style.transition = 'all 0.3s ease';
    setTimeout(() => {
      if (toast.parentElement) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, duration);
}

// --- FUNGSI START SCAN (ANTI MACET) ---
function startScan() {
  if(scanning) return; // Cegah klik ganda

  try {
    // Reset Tampilan
    document.getElementById("result").innerHTML = '<span class="result-status"><span class="result-status-icon">üîÑ</span> Membuka kamera...</span>';
    
    // Inisialisasi Scanner
    qr = new Html5Qrcode("qr-reader");
    
    // KUNCI TOMBOL (Scanning aktif)
    scanning = true; 

    qr.start(
      { facingMode: cameraFacing }, 
      { fps: 10, qrbox: 250 }, 
      onScan, 
      (errorMessage) => {
        // Error saat scanning berjalan (abaikan saja agar tidak spam)
      }
    ).catch((err) => {
      // ‚ö†Ô∏è JIKA KAMERA GAGAL DIBUKA (Misal: Izin ditolak)
      console.error(err);
      document.getElementById("result").innerHTML = `<span class="result-status"><span class="result-status-icon">‚ùå</span> Kamera Error: ${err}</span>`;
      
      // BUKA KUNCI AGAR BISA KLIK PLAY LAGI
      scanning = false; 
    });

    document.getElementById("result").innerHTML = '<span class="result-status"><span class="result-status-icon">üì∑</span> Arahkan ke QR...</span>';
    
  } catch(e) {
    // Error tak terduga
    document.getElementById("result").innerHTML = `<span class="result-status"><span class="result-status-icon">‚ùå</span> ${e.message}</span>`;
    scanning = false; // Buka kunci
  }
}

// Update stopScan agar punya fitur "Silent"
function stopScan(silent = false) {
  if(!qr || !scanning) return;
  
  qr.stop().then(() => {
    qr.clear();
    scanning = false;
    
    // HANYA ubah tulisan jadi "Dihentikan" jika mode silent MATI
    // Kalau silent = true, layar tidak akan diganggu (tetap menampilkan pesan error detail)
    if (!silent) {
        document.getElementById("result").innerHTML = '<span class="result-status"><span class="result-status-icon">üî¥</span> Dihentikan</span>';
    }
  }).catch((err) => {
    console.log("Stop failed: ", err);
  });
}

async function onScan(decodedText) {
  if(decodedText === lastCode) return;
  lastCode = decodedText;
  
  const result = document.getElementById("result");
  result.className = "";
  
  // 1. Ambil ID Unit Bersih
  const extractedUnit = extractUnitIdFromQR(decodedText);
  result.innerHTML = `<span class="result-status"><span class="result-status-icon">‚úì</span> QR: ${extractedUnit}</span>`;
  playBeep("scanning");
  
  // 2. Cek apakah unit terdaftar di Database (Frontend Check)
  if (!isValidUnitFrontend(decodedText)) {
    result.className = "status-invalid";
    result.innerHTML = `<span class="result-status"><span class="result-status-icon">‚ùå</span> Unit tidak terdaftar!</span>`;
    speak("Unit tidak terdaftar", "error");
    stopScan();
    return;
  }

  // üî• PERUBAHAN LOGIKA DISINI (ONLINE FIRST) üî•
  // Kita cek koneksi internet dulu.
  
  if (navigator.onLine) {
      // --- KASUS A: ONLINE ---
      // Langsung tanya server (Abaikan cek lokal dulu, biar server yang memutuskan)
      // Ini mengatasi masalah unit ditolak padahal di server sudah boleh.
      
      apiRetryCount = 0;
      const device = /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop";
      processQRCode(decodedText, device, result);
      
  } else {
      // --- KASUS B: OFFLINE ---
      // Baru kita gunakan logic "Offline Guard" (Satpam Lokal)
      handleOfflineLogic(extractedUnit, decodedText, result);
  }
}   

// --- LOGIC PENANGANAN SAAT OFFLINE (SATPAM LOKAL) ---
function handleOfflineLogic(unitId, originalText, result) {
    const localCheck = checkLocalHistoryAllowed(unitId);

    if (!localCheck.allowed) {
        // ... (Kode kalkulasi jam biarkan sama) ...
        const sisaWaktu = toHourMinute(localCheck.minutesRemaining);
        const jamTerakhir = localCheck.lastTime.getHours().toString().padStart(2, '0') + ":" + localCheck.lastTime.getMinutes().toString().padStart(2, '0');
        
        reportRejectionDirectly(unitId, "INTERVAL BELUM TERCAPAI (OFFLINE)");

        result.className = "status-disallowed";
        result.innerHTML = `
        <div class="result-status" style="animation: pulse-glow 1s infinite alternate;">
          <span class="result-status-icon" style="font-size: 40px;">‚õî</span>
          <span class="result-unit">${unitId} (OFFLINE)</span>
          <div style="margin: 10px 0; border-top: 1px dashed var(--neon-red); width: 100%; opacity: 0.5;"></div>
          <div style="text-align: left; width: 100%; font-size: 14px; padding: 0 10px;">
             üìÖ Terakhir: <b style="color: #fff;">${jamTerakhir}</b><br>
             ‚è≥ Tunggu: <b style="color: #ffcc00; font-size: 16px;">${sisaWaktu}</b> lagi
          </div>
          <button onclick="startScan()" style="margin-top: 15px; background: rgba(220, 38, 38, 0.2); border: 1px solid var(--neon-red); color: var(--neon-red); padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-family: 'Orbitron'; text-transform: uppercase;">SCAN UNIT LAIN üîÑ</button>
        </div>
        `;
        speak(`Ditolak offline. Unit baru saja mengisi.`, "error");
        playBeep("error");
        
        stopScan(true); // <--- REVISI: PAKAI TRUE (SILENT)

    } else {
        processOfflineSuccess(originalText, result);
    }
}

async function processQRCode(decodedText, device, result, retryCount = 0) {
  // 1. CEK KONEKSI BROWSER (Layer Pertama)
  // Jika browser sadar dia offline, lempar ke Logic Offline (Satpam Lokal)
  if (!navigator.onLine) {
    const unitId = extractUnitNumber(decodedText);
    handleOfflineLogic(unitId, decodedText, result);
    return;
  }

  try {
    const formData = new FormData();
    formData.append("qrData", decodedText);
    formData.append("userAgent", navigator.userAgent);
    formData.append("device", device);
    formData.append("line", line);
    
    // Timeout 10 detik agar tidak menunggu selamanya jika sinyal lemot
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    
    // Tambahkan redirect: 'follow' agar aman di HP Android
    const response = await fetch(apiUrl, { 
        method: "POST", 
        body: formData, 
        signal: controller.signal,
        redirect: "follow" 
    });
    
    clearTimeout(timeout);
    
    const data = await response.json();
    
    if (data.status === "success") {
      // SUKSES DARI SERVER
      handleScanSuccess(data, decodedText, result);
    } else if (data.refuelingStatus === "INVALID_QR") {
      // QR TIDAK DIKENAL SERVER
      result.className = "status-invalid";
      result.innerHTML = `<span class="result-status"><span class="result-status-icon">‚ùå</span> ${data.message}</span>`;
      speak(data.message, "error");
    } else {
      // DITOLAK SERVER (Disallowed)
      handleScanSuccess(data, decodedText, result);
    }

  } catch (err) {
    console.warn("‚ö†Ô∏è Gagal koneksi server (Timeout/Error), beralih ke Satpam Lokal:", err);
    
    // üî• REVISI PENTING DISINI (FALLBACK) üî•
    // Jangan langsung 'processOfflineSuccess' (Diterima).
    // Kita harus tanya dulu ke 'handleOfflineLogic' (Cek history lokal).
    
    const unitId = extractUnitNumber(decodedText);
    handleOfflineLogic(unitId, decodedText, result);
  }
}

// Tambahkan Fungsi Kecil Ini di bawah processQRCode

function processOfflineSuccess(qrText, result) {
    const unitId = extractUnitNumber(qrText); // Misal dapat "DT030-0123"
    
    // 1. Buka Kamus Data di HP
    const localDB = JSON.parse(localStorage.getItem('unitDetailsDB') || '{}');
    
    // 2. Cari Namanya (Kalau tidak ada, pakai default strip "-")
    const unitNameFromDB = localDB[unitId] || "UNIT TERDAFTAR (OFFLINE)";

    const fakeData = {
        refuelingStatus: "ALLOWED",
        unitId: unitId,
        unitName: unitNameFromDB, // <--- INI DIA RAHASIANYA
        minutesRemaining: 0
    };
    
    result.innerHTML = `<span class="result-status"><span class="result-status-icon">üì°</span> Offline Mode</span>`;
    speak("Mode offline. Unit dikenali.");
    handleScanSuccess(fakeData, qrText, result);
}

// --- UPDATE FUNGSI HANDLE SUCCESS (TAMPILAN KONSISTEN & FIX TOMBOL) ---
function handleScanSuccess(data, decodedText, result) {
  const status = data.refuelingStatus;
  const minutes = data.minutesRemaining;
  const waktuSisaStr = toHourMinute(minutes);
  
  lastCode = null; 

  if (status === "ALLOWED") {
    // KASUS DITERIMA: Tetap pakai stopScan() biasa karena layar akan diganti form input
    document.querySelector('.qr-display-area').style.display = 'none';
    document.getElementById('quantityArea').style.display = 'block';
    
    document.getElementById('targetUnitID').textContent = data.unitId;
    document.getElementById('targetUnitSpec').textContent = data.unitName;
    
    currentUnitId = data.unitId; 
    currentLastHM = parseFloat(data.lastHM) || 0; 
    
    stopScan(true); // Silent, karena layar scanner disembunyikan
    playBeep("success");
    speak(`Unit ${data.unitId} diizinkan.`, "success");
    
    setTimeout(() => { 
      const inputLiter = document.getElementById('literInput');
      inputLiter.focus();
      inputLiter.click(); 
    }, 500);

  } else if (status === "DISALLOWED") {
    // --- REVISI DISINI: PAKAI stopScan(true) ---
    stopScan(true); // <--- MATIKAN KAMERA TANPA MENGHAPUS PESAN ERROR
    scanning = false; 
    
    let fullUnitNumber = extractUnitNumber(decodedText);
    let jamRefuel = data.allowedTimestampStr ? parseTimestampSimple(data.allowedTimestampStr) : "-";
    const allowedLine = data.lineName || line;

    result.className = "status-disallowed";
    result.innerHTML = `
      <div class="result-status" style="animation: pulse-glow 1s infinite alternate;">
        <span class="result-status-icon" style="font-size: 40px;">‚õî</span>
        <span class="result-unit" style="font-size: 24px; color: var(--neon-red); font-family: 'Orbitron';">${fullUnitNumber}</span>
        <div style="margin: 10px 0; border-top: 1px dashed var(--neon-red); width: 100%; opacity: 0.5;"></div>
        <div style="text-align: left; width: 100%; font-size: 14px; padding: 0 10px;">
           üìÖ Terakhir: <b style="color: #fff;">${jamRefuel}</b><br>
           üìç Lokasi: <b style="color: #fff;"> LINE ${allowedLine}</b><br>
           ‚è≥ Tunggu: <b style="color: #ffcc00; font-size: 16px;">${waktuSisaStr}</b> lagi
        </div>
        <button onclick="startScan()" style="margin-top: 15px; background: rgba(220, 38, 38, 0.2); border: 1px solid var(--neon-red); color: var(--neon-red); padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-family: 'Orbitron'; text-transform: uppercase;">SCAN UNIT LAIN üîÑ</button>
      </div>
    `;
    
    const pesanSuara = `Pengisian ditolak. Unit ${fullUnitNumber} sudah mengisi pada pukul ${jamRefuel}, di LINE ${allowedLine}. Tunggu ${waktuSisaStr} lagi.`;
    speak(pesanSuara, "error");
    playBeep("error");

  } else if (status === "INVALID_QR") {
    // --- REVISI DISINI JUGA ---
    stopScan(true); // <--- Silent Mode
    scanning = false;
    
    result.className = "status-invalid";
    result.innerHTML = `
        <span class="result-status">
            <span class="result-status-icon" style="font-size: 30px;">‚ùå</span> 
            <span style="color: var(--neon-red); font-weight: bold;">UNIT TIDAK TERDAFTAR</span>
            <div style="font-size: 12px; margin-top:5px; color:#fff;">Hubungi Admin Logistik</div>
            <button onclick="startScan()" style="margin-top: 10px; padding: 8px 15px; border-radius: 8px; border: 1px solid #fff; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer;">SCAN ULANG</button>
        </span>
    `;
    speak("Unit tidak terdaftar", "error");
    playBeep("error");
  }
}

function playBeep(type) {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') {
      audioContext.resume().then(() => {
        playBeepSound(audioContext, type);
      });
    } else {
      playBeepSound(audioContext, type);
    }
  } catch (err) {
    console.log("Beep error:", err);
  }
}

function playBeepSound(audioContext, type) {
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  if (type === "scanning") {
    osc.frequency.value = 800;
    gain.gain.setValueAtTime(0.25, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    osc.start(audioContext.currentTime);
    osc.stop(audioContext.currentTime + 0.2);
  } else if (type === "success") {
    osc.frequency.value = 900;
    gain.gain.setValueAtTime(0.4, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
    osc.start(audioContext.currentTime);
    osc.stop(audioContext.currentTime + 0.15);
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.connect(gain2);
    gain2.connect(audioContext.destination);
    osc2.frequency.value = 1100;
    gain2.gain.setValueAtTime(0.4, audioContext.currentTime + 0.25);
    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
    osc2.start(audioContext.currentTime + 0.25);
    osc2.stop(audioContext.currentTime + 0.4);
  } else if (type === "error") {
    osc.frequency.value = 400;
    gain.gain.setValueAtTime(0.4, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    osc.start(audioContext.currentTime);
    osc.stop(audioContext.currentTime + 0.2);
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.connect(gain2);
    gain2.connect(audioContext.destination);
    osc2.frequency.value = 400;
    gain2.gain.setValueAtTime(0.4, audioContext.currentTime + 0.35);
    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.55);
    osc2.start(audioContext.currentTime + 0.35);
    osc2.stop(audioContext.currentTime + 0.55);
    const osc3 = audioContext.createOscillator();
    const gain3 = audioContext.createGain();
    osc3.connect(gain3);
    gain3.connect(audioContext.destination);
    osc3.frequency.value = 400;
    gain3.gain.setValueAtTime(0.4, audioContext.currentTime + 0.7);
    gain3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.9);
    osc3.start(audioContext.currentTime + 0.7);
    osc3.stop(audioContext.currentTime + 0.9);
  }
}



// ==========================================
// fungsi pengecekan quantity liter
// ==========================================
function checkLiterLimit(input) {
    const maxLiter = 333;
    const warningText = document.getElementById("literWarning");
    const val = parseFloat(input.value);

    if (val > maxLiter) {
        input.style.borderColor = "red";
        input.style.backgroundColor = "#FEF2F2";
        warningText.style.display = "block";
    } else {
        input.style.borderColor = "#10B981"; // Kembali Hijau
        input.style.backgroundColor = "#ECFDF5";
        warningText.style.display = "none";
    }
}

// üî• UPDATE FUNGSI SUBMIT (LOGIKA FIX & BERSIH)

async function submitFinalData() {
    // 1. Cek apakah sedang memproses data sebelumnya?
    if (isProcessing) return; 

    const btn = document.getElementById('saveLiterBtn');
    const literInput = document.getElementById('literInput');
    const hmInput = document.getElementById('hmInput');
    
    // Ambil value dan ubah ke Angka (Float) agar bisa dihitung
    const literVal = parseFloat(literInput.value);
    const hmVal = parseFloat(hmInput.value); // PENTING: HM harus jadi angka untuk validasi lonjakan

    // --- BATAS PENGISIAN ---
    const MAX_LITER = 333;

    // 2. VALIDASI DASAR (KOSONG)
    if (!literInput.value || !hmInput.value) {
        alert("‚ö†Ô∏è Mohon isi Jumlah Solar dan HM!");
        return;
    }

    // 3. üî• VALIDASI BATAS ATAS (MAKSIMAL 333 LITER) üî•
    if (literVal > MAX_LITER) {
        alert(`‚ùå ERROR: MELEBIHI KAPASITAS!\nMaksimal pengisian adalah ${MAX_LITER} Liter.`);
        
        if (typeof speak === "function") speak(`Pengisian terlalu banyak. Maksimal ${MAX_LITER} liter.`, "error");
        if (typeof playBeep === "function") playBeep("error");
        
        literInput.style.borderColor = "red"; 
        literInput.value = ""; 
        literInput.focus();
        
        return; // ‚õî STOP DISINI
    }

    // 4. üî• VALIDASI BATAS BAWAH (MINUS ATAU 0) üî•
    if (literVal <= 0) {
        alert("‚ùå ERROR: JUMLAH TIDAK VALID!\nJumlah solar tidak boleh 0 atau minus.");
        
        if (typeof speak === "function") speak("Jumlah liter tidak valid.", "error");
        if (typeof playBeep === "function") playBeep("error");

        literInput.style.borderColor = "red";
        literInput.focus();
        
        return; // ‚õî STOP DISINI
    }

    // 5. üî• DETEKSI ANOMALI HM (SOFT VALIDATION) üî•
    // Logika ini hanya jalan jika 'currentLastHM' memiliki nilai (dari Backend)
    if (currentLastHM > 0) {
        let isAnomaly = false;
        let warningText = "";

        // KASUS A: HM Turun (Current < Last)
        if (hmVal < currentLastHM) {
            isAnomaly = true;
            warningText = `‚ö†Ô∏è PERINGATAN: HM TURUN!\n\nHM terakhir: ${currentLastHM}\nHM sekarang: ${hmVal}\n\nNilai HM lebih kecil dari sebelumnya.`;
        } 
        // KASUS B: HM Loncat > 20 Jam
        else if (hmVal > (currentLastHM + 20)) {
            isAnomaly = true;
            warningText = `‚ö†Ô∏è PERINGATAN: LONJAKAN HM!\n\nHM terakhir: ${currentLastHM}\nHM sekarang: ${hmVal}\n\nAda ANOMALI selisih HM lebih dari 20 HM .`;
        }

        // JIKA ADA ANOMALI, TAMPILKAN KONFIRMASI
        if (isAnomaly) {
            // Mainkan suara peringatan
            if (typeof speak === "function") speak("Peringatan. Periksa kembali input Hour Meter.", "error");
            if (typeof playBeep === "function") playBeep("error");

            // Munculkan Dialog Konfirmasi
            const userConfirmed = confirm(`${warningText}\n\nHM mu terakhir pengisian adalah ${currentLastHM}.\nApakah anda yakin nilai HM anda sekarang ${hmVal}?`);

            if (!userConfirmed) {
                // Jika User pilih "Cancel" / "Tidak"
                hmInput.focus();
                hmInput.style.borderColor = "red";
                return; // ‚õî BATALKAN PENGIRIMAN
            }
            // Jika User pilih "OK", lanjut ke bawah (Kirim Data)
        }
    }

    // --- JIKA LOLOS SEMUA VALIDASI, BARU PROSES ---
    
    // KUNCI TOMBOL
    isProcessing = true;
    btn.disabled = true;
    btn.innerHTML = "‚è≥ MENGIRIM...";

    const payload = {
        unitId: currentUnitId,
        liter: literVal, // Kirim angka valid
        hm: hmVal,       // Kirim angka valid
        line: user,
        device: "Mobile Trial"
    };

    try {
        const formData = new FormData();
        formData.append("action", "submitRefuel");
        formData.append("unitId", payload.unitId);
        formData.append("liter", payload.liter);
        formData.append("hm", payload.hm);
        formData.append("line", payload.line);
        formData.append("device", payload.device);

        // Timeout 10 detik
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(apiUrl, { 
            method: "POST", 
            body: formData, 
            signal: controller.signal,
            redirect: "follow" 
        });
        
        clearTimeout(timeout);
        const resData = await response.json();

        if (resData.status === "success") {
            // ‚úÖ SUKSES ONLINE
            saveLocalHistory(currentUnitId);
            if (typeof playBeep === "function") playBeep("success");
            alert("‚úÖ DATA BERHASIL TERKIRIM!");
            location.reload(); 
        } else {
            throw new Error(resData.message || "Ditolak Server");
        }

    } catch (err) {
        console.warn("‚ö†Ô∏è Gagal Online, Beralih ke Offline:", err);
        
        // --- DIAGNOSA ERROR ---
        // Kita cek apakah ini murni masalah sinyal atau masalah kodingan/server
        if (!navigator.onLine) {
             // Ini beneran Offline (Internet mati)
             alert("üì° MODE OFFLINE: Sinyal HP hilang. Data disimpan di internal.");
        } else {
             // Ini Internet Nyala tapi Server Menolak (Kemungkinan masalah Deploy/Script)
             alert(`‚ö†Ô∏è GAGAL KONEKSI SERVER!\n\nPesan Error: ${err.message}\n\n(Internet anda aktif, tapi Server menolak. Cek Izin Deployment Script "Anyone").\n\nData tetap disimpan di HP.`);
        }

        // ‚ö†Ô∏è MASUK OFFLINE
        saveLocalHistory(currentUnitId);
        
        // Simpan ke antrean offline
        let queue = JSON.parse(localStorage.getItem('pendingRefuels') || '[]');
        queue.push(payload);
        localStorage.setItem('pendingRefuels', JSON.stringify(queue));
        
        alert("üì° MODE OFFLINE: Data disimpan di HP (Akan terkirim otomatis saat Device mendapatkan sinyal)");
        location.reload();
    } finally {
        isProcessing = false;
    }
}


// üîÑ FUNGSI SINKRONISASI (DATA LITER + LAPORAN PENOLAKAN)

async function uploadPendingData() {
    // Cek koneksi internet dulu
    if (!navigator.onLine) return; 

    // Jika sedang proses, jangan jalankan lagi
    if (isSyncing) return; 
    
    let refuelQueue = JSON.parse(localStorage.getItem('pendingRefuels') || '[]');
    let rejectQueue = JSON.parse(localStorage.getItem('pendingRejections') || '[]');

    // Jika antrean kosong, stop
    if (refuelQueue.length === 0 && rejectQueue.length === 0) return;

    isSyncing = true; // üîí Kunci aktif
    
    // üí° RAHASIA: Kosongkan localStorage agar tidak dibaca ulang oleh Heartbeat Sync berikutnya
    localStorage.setItem('pendingRefuels', '[]');
    localStorage.setItem('pendingRejections', '[]');

    const banner = document.getElementById('offlineBanner');
    
    // Tampilkan Status MENGIRIM (Kuning/Loading)
    banner.classList.add('show');
    banner.classList.remove('success-sync'); // Reset style
    banner.innerHTML = `üîÑ MENGIRIM ${refuelQueue.length + rejectQueue.length} DATA TERTUNDA...`;

    let failedRefuels = [];
    let failedRejections = [];

    // --- 1. PROSES REFUEL ---
    for (const item of refuelQueue) {
        try {
            const formData = new FormData();
            formData.append("action", "submitRefuel");
            formData.append("unitId", item.unitId);
            formData.append("liter", item.liter);
            formData.append("hm", item.hm);
            formData.append("line", item.line);
            formData.append("device", "Mobile (Synced)");
            if(item.timestamp) formData.append("originalTime", item.timestamp);

            const response = await fetch(apiUrl, { method: "POST", body: formData, redirect: "follow" });
            // Cek apakah server merespon success
            const resData = await response.json();
            if(resData.status !== "success") throw new Error("Server Error");

        } catch (err) {
            console.warn("Gagal kirim item refuel:", err);
            failedRefuels.push(item); // Tampung untuk dikembalikan
        }
    }

    // --- 2. PROSES PENOLAKAN (WA) ---
    for (const item of rejectQueue) {
        try {
            const formData = new FormData();
            formData.append("action", "reportOfflineRejection");
            formData.append("unitId", item.unitId);
            formData.append("line", item.line);
            formData.append("timestamp", item.timestamp);
            
            await fetch(apiUrl, { method: "POST", body: formData });
        } catch (err) {
            console.warn("Gagal kirim item reject:", err);
            failedRejections.push(item);
        }
    }

    // --- 3. HANDLING GAGAL & SUKSES ---

    // A. Kembalikan data yang gagal ke localStorage (jika ada)
    if (failedRefuels.length > 0) {
        let current = JSON.parse(localStorage.getItem('pendingRefuels') || '[]');
        localStorage.setItem('pendingRefuels', JSON.stringify([...current, ...failedRefuels]));
    }
    if (failedRejections.length > 0) {
        let current = JSON.parse(localStorage.getItem('pendingRejections') || '[]');
        localStorage.setItem('pendingRejections', JSON.stringify([...current, ...failedRejections]));
    }

    // B. CEK HASIL AKHIR (HIJAU JIKA SUKSES SEMUA)
    if (failedRefuels.length === 0 && failedRejections.length === 0) {
        // ‚úÖ SEMUA BERHASIL
        banner.innerHTML = `‚úÖ DATA TERTUNDA BERHASIL TERKIRIM!`;
        banner.classList.add('success-sync'); // Ubah jadi Hijau Futuristik
        
        // Bunyi notif (jika ada fiturnya)
        if (typeof playBeep === 'function') playBeep("success");

        // Tahan banner hijau selama 4 detik, lalu sembunyikan
        if (bannerTimeout) clearTimeout(bannerTimeout); // Reset timer lama jika ada
        
        bannerTimeout = setTimeout(() => {
            // Cek lagi: Kalau tiba-tiba offline saat nunggu, jangan sembunyikan!
            if (navigator.onLine) { 
                banner.classList.remove('show');
                banner.classList.remove('success-sync'); 
            }
            isSyncing = false; // üîì Buka kunci
        }, 4000);

    } else {
        // ‚ùå ADA YANG GAGAL (Sinyal putus di tengah jalan)
        // Langsung sembunyikan banner agar nanti dicoba lagi oleh interval berikutnya
        banner.classList.remove('show');
        isSyncing = false; // üîì Buka kunci
    }
}


// üß† FITUR OFFLINE: CEK INTERVAL 8 JAM (LOCAL MEMORY)
// ==========================================
const REFUEL_INTERVAL_HOURS = 8; // Atur durasi interval di sini

function saveLocalHistory(unitId) {
    let history = JSON.parse(localStorage.getItem('unitHistory') || '{}');
    history[unitId] = new Date().getTime(); // Simpan jam sekarang
    localStorage.setItem('unitHistory', JSON.stringify(history));
    console.log(`üíæ History tersimpan lokal untuk: ${unitId}`);
}

  function checkLocalHistoryAllowed(unitId) {
    let history = JSON.parse(localStorage.getItem('unitHistory') || '{}');
    const lastRefuel = history[unitId];

    if (!lastRefuel) return { allowed: true }; // Belum pernah isi di HP ini

    const now = new Date().getTime();
    const diffMs = now - lastRefuel;
    const diffHours = diffMs / (1000 * 60 * 60);

    if (diffHours < REFUEL_INTERVAL_HOURS) {
        // Hitung sisa waktu
        const remainingMs = (REFUEL_INTERVAL_HOURS * 60 * 60 * 1000) - diffMs;
        const remainingMinutes = Math.ceil(remainingMs / (1000 * 60));
        return { 
            allowed: false, 
            minutesRemaining: remainingMinutes,
            lastTime: new Date(lastRefuel) 
        };
    }

    return { allowed: true };
}

  // ==========================================
  // üìù FUNGSI CATAT PENOLAKAN KE MEMORI HP
  // ==========================================
  function queueOfflineRejection(unitId, reason) {
    let rejections = JSON.parse(localStorage.getItem('pendingRejections') || '[]');
    rejections.push({
        unitId: unitId,
        line: user, 
        timestamp: new Date().getTime(),
        reason: reason
    });
    localStorage.setItem('pendingRejections', JSON.stringify(rejections));
    console.log(`üìù Laporan penolakan disimpan lokal untuk: ${unitId}`);
  } 

  // üîÑ HEARTBEAT SYNC: Cek data tertunda setiap 15 detik secara otomatis
  setInterval(() => {
  if (navigator.onLine) {
    console.log("üîç Memeriksa antrean data offline...");
    uploadPendingData();
    }
    }, 30000); // 15000 ms = 15 detik  

    // ==========================================
// üöÄ FUNGSI KIRIM REJECT LANGSUNG (REAL-TIME)
// ==========================================
// ==========================================
// üöÄ FUNGSI KIRIM REJECT LANGSUNG (REAL-TIME)
// ==========================================
async function reportRejectionDirectly(unitId, reason) {
    if (!navigator.onLine) {
        queueOfflineRejection(unitId, reason);
        return;
    }
    try {
        const formData = new FormData();
        formData.append("action", "reportOfflineRejection");
        formData.append("unitId", unitId);
        formData.append("line", user);
        formData.append("timestamp", new Date().getTime());
        formData.append("reason", reason);

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000);

        await fetch(apiUrl, { method: "POST", body: formData, signal: controller.signal });
        clearTimeout(timeout);
        console.log("‚úÖ Rejection terkirim ke WA secara Direct");
    } catch (err) {
        console.warn("Gagal kirim reject langsung, menyimpan ke antrean...", err);
        queueOfflineRejection(unitId, reason);
    }
}

// ==========================================
// üíì HEARTBEAT SYNC: JANTUNG OTOMATIS
// ==========================================
// Kode ini akan "berdenyut" setiap 5 detik untuk mengecek apakah ada sinyal & data tertunda
  setInterval(() => {
    if (navigator.onLine) {
        let pendingRefuel = JSON.parse(localStorage.getItem('pendingRefuels') || '[]');
        let pendingReject = JSON.parse(localStorage.getItem('pendingRejections') || '[]');

        // Jika ada data DAN tidak sedang proses kirim
        if ((pendingRefuel.length > 0 || pendingReject.length > 0) && !isSyncing) {
            console.log("‚ö° Sinyal Stabil & Ada Data Tertunda -> Eksekusi Upload...");
            uploadPendingData();
        }
    }
  }, 5000);
</script>

<!-- üîß SERVICE WORKER REGISTRATION -->
<script>
// üì± Register Service Worker untuk PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registered:', registration);
        
        // Check untuk update setiap jam
        setInterval(() => {
          registration.update();
        }, 60 * 60 * 1000); // 1 jam
      })
      .catch((error) => {
        console.error('‚ùå Service Worker registration failed:', error);
      });
  });
} else {
  console.warn('‚ö†Ô∏è Service Worker not supported in this browser');
}

// üîî Listen untuk update tersedia
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('controller', () => {
    console.log('üì¢ New Service Worker activated');
  });
}
</script>

</body>
</html>